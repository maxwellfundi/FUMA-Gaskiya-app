{"version":3,"sources":["../../src/pages/form-view/form-view.module.ts","../../src/pages/form-view/form-view.ts"],"names":[],"mappings":"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","file":"57.js","sourcesContent":["import { NgModule } from '@angular/core';\r\nimport { IonicPageModule } from 'ionic-angular';\r\nimport { FormViewPage } from './form-view';\r\n//import { TranslationModule } from '../../translation/translate.module'\r\nimport { TranslateModule, TranslateLoader } from '@ngx-translate/core';\r\n\r\n@NgModule({\r\n  declarations: [FormViewPage],\r\n  imports: [TranslateModule, IonicPageModule.forChild(FormViewPage)],\r\n  exports: [FormViewPage]\r\n})\r\nexport class FormViewPageModule { }\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/form-view/form-view.module.ts","import { Component } from '@angular/core';\r\nimport { NavParams, ViewController, IonicPage } from 'ionic-angular';\r\nimport { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';\r\nimport { Camera } from '@ionic-native/camera';\r\nimport { PouchdbProvider } from '../../providers/pouchdb-provider';\r\nimport { Storage } from '@ionic/storage';\r\nimport { TranslateService  } from '@ngx-translate/core';\r\nimport { global } from '../../global-variables/variable'\r\n\r\n\r\n@IonicPage()\r\n@Component({\r\n  selector: 'page-form-view',\r\n  templateUrl: 'form-view.html'\r\n})\r\n\r\nexport class FormViewPage {\r\n  form: any;\r\n  enketoLink: SafeResourceUrl;\r\n  iframeHeight: any;\r\n  instanceID: string;\r\n  public base64Image: string;\r\n  public showCamera = true;\r\n  local: Storage;\r\n\r\n  constructor(public translate: TranslateService, private params: NavParams, public viewCtrl: ViewController, private sanitizer: DomSanitizer, private database: PouchdbProvider, private camera:Camera) {\r\n    console.log('params', params.data)\r\n    this.form = params.data.doc;\r\n    this.instanceID = this.setInstanceID();\r\n    var iframeLink = this.setIframeLink(this.form.enketoLink);\r\n    console.log('iframe link', iframeLink)\r\n    console.log('instanceID', this.instanceID)\r\n    this.enketoLink = this.sanitizer.bypassSecurityTrustResourceUrl(iframeLink);\r\n    this.iframeHeight = \"100%\";\r\n    this.translate.setDefaultLang(global.langue)\r\n\r\n\r\n  }\r\n  ionViewDidLoad() {\r\n    this.translate.use(global.langue)\r\n    //add event listener for messages sent from enketo iframe\r\n    //note - currently not useful as enketo only correctly firing message on edit start but not submission success\r\n    //https://github.com/kobotoolbox/enketo-express/issues/670\r\n    window.addEventListener(\"message\", receiveMessage, false);\r\n    function receiveMessage(event) {\r\n      // TODO in real life, check origin! if (event.origin !== \"http://enk.to:8080\") return;\r\n      console.log('data received from iframe', event);\r\n    }\r\n  }\r\n  //generate an instance id when entering form to link \r\n  ionViewDidEnter() {\r\n\r\n  }\r\n  close() {\r\n    //ideally want to minimise/make transparent so forms keep attempting upload\r\n    //will need to move code onto new form tab or combine into collect tab\r\n\r\n    // var iframe = window.frames['form-iframe']\r\n    // console.log('iframe doc', iframe.document)\r\n    // console.log('content window', iframe.contentWindow)\r\n    this.viewCtrl.dismiss()\r\n    //this.iframeHeight=\"100px\"\r\n  }\r\n  takePhoto() {\r\n    // console.log('hacking into enketo storage');\r\n    // this.local = new Storage(['indexeddb', 'websql', 'localstorage'], { name: 'enketo', storeName: 'keyvaluepairs' });\r\n    // this.local.get('properties').then(res => console.log('get request', res))\r\n    // this.local.set('test','hii')\r\n    this.camera.getPicture({\r\n      destinationType: this.camera.DestinationType.DATA_URL,\r\n      quality: 50,\r\n      targetWidth: 1000,\r\n      targetHeight: 1500,\r\n      saveToPhotoAlbum: false,\r\n      correctOrientation:true\r\n    }).then((imageData) => {\r\n      // imageData is a base64 encoded string\r\n      this.base64Image = \"data:image/jpeg;base64,\" + imageData;\r\n      let fileName=this.instanceID+'.jpeg'\r\n      var doc = {\r\n        _attachments: {},\r\n        photoID: this.instanceID,\r\n        timestamp: new Date().toString(),\r\n      }\r\n      doc._attachments[fileName] = {\r\n        content_type: 'image/jpeg',\r\n        data:imageData\r\n      }  \r\n      this.database.put(doc, 'photos_'+this.form.id_string+'/'+this.instanceID)\r\n    }, (err) => {\r\n      console.log(err);\r\n    });\r\n  }\r\n  setIframeLink(link) {\r\n    //create autopopulate query parameters (currently only a deprecated instanceID, later could pull multiple)\r\n    //need to make sure field isn't removed in future update. Query logged on other ways to populate a non interactive element (so user can't change it)\r\n    var fillField = \"meta/instanceID\";\r\n    var fillValue = this.instanceID;\r\n    var fillQueryParam = \"[/\" + this.form.id_string + '/' + fillField + \"]=\" + fillValue;\r\n    //add callback window parameter to receive postmessage from enketo iframe\r\n    var origin = window.location.origin\r\n    var originQueryParam = \"parentWindowOrigin=\" + encodeURI(origin)\r\n    //rewrite url to put query params before id for offline form \r\n    //more info see https://help.ona.io/faq/prefilling-form-fields-using-enketo and https://github.com/kobotoolbox/enketo-express/issues/386\r\n    //warning - could easily be broken by changes to enketo\r\n    var stringLength = link.length\r\n    var linkPrefix = link.slice(0, stringLength - 7)\r\n    var linkSuffix = link.slice(stringLength - 5)\r\n    return linkPrefix + '_/?d' + fillQueryParam + '&' + originQueryParam + linkSuffix\r\n    // var testLink1= 'https://ee.kobotoolbox.org/_/?d[/fuma-op-membre/nom_Membre]=chris#YPfh'\r\n    // var testLink2= 'https://ee.kobotoolbox.org/_/?parentWindowOrigin=http%3A%2F%2Flocalhost:8100#YPfh'\r\n    //var testLink3= 'https://ee.kobotoolbox.org/::YPfh?parentWindowOrigin=http%3A%2F%2Flocalhost:8100#YPfh'\r\n  }\r\n  setInstanceID() {\r\n    //code used by polymer to create pushid. As not exposed to api (?) running manually\r\n    // https://gist.github.com/mikelehen/3596a30bd69384624c11\r\n    //https://firebase.googleblog.com/2015/02/the-2120-ways-to-ensure-unique_68.html\r\n    // Modeled after base64 web-safe chars, but ordered by ASCII.\r\n    var PUSH_CHARS = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';\r\n    // Timestamp of last push, used to prevent local collisions if you push twice in one ms.\r\n    var lastPushTime = 0;\r\n    // We generate 72-bits of randomness which get turned into 12 characters and appended to the\r\n    // timestamp to prevent collisions with other clients.  We store the last characters we\r\n    // generated because in the event of a collision, we'll use those same characters except\r\n    // \"incremented\" by one.\r\n    var lastRandChars = [];\r\n    var now = new Date().getTime();\r\n    var duplicateTime = (now === lastPushTime);\r\n    lastPushTime = now;\r\n    var timeStampChars = new Array(8);\r\n    for (var i = 7; i >= 0; i--) {\r\n      timeStampChars[i] = PUSH_CHARS.charAt(now % 64);\r\n      // NOTE: Can't use << here because javascript will convert to int and lose the upper bits.\r\n      now = Math.floor(now / 64);\r\n    }\r\n    if (now !== 0) throw new Error('We should have converted the entire timestamp.');\r\n    var id = timeStampChars.join('');\r\n    if (!duplicateTime) {\r\n      for (i = 0; i < 12; i++) {\r\n        lastRandChars[i] = Math.floor(Math.random() * 64);\r\n      }\r\n    } else {\r\n      // If the timestamp hasn't changed since last push, use the same random number, except incremented by 1.\r\n      for (i = 11; i >= 0 && lastRandChars[i] === 63; i--) {\r\n        lastRandChars[i] = 0;\r\n      }\r\n      lastRandChars[i]++;\r\n    }\r\n    for (i = 0; i < 12; i++) {\r\n      id += PUSH_CHARS.charAt(lastRandChars[i]);\r\n    }\r\n    if (id.length != 20) throw new Error('Length should be 20.');\r\n    return id\r\n  };\r\n}\r\n\r\n\r\n\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/form-view/form-view.ts"],"sourceRoot":""}