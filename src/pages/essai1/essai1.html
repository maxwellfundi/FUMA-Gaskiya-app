<!--
  Generated template for the Essai page.

  See http://ionicframework.com/docs/v2/components/#navigation for more info on
  Ionic pages and navigation.
-->
<ion-header>

  <ion-navbar color="fuma_primary">
    <ion-buttons *ngIf="a_matricule && !ajoutForm && !modifierFrom && !detailEssai" left>
      <button ion-button icon-only color="royal" (click)="dismiss()"> Fermer <!--ion-icon name="arrow-back"></ion-icon--></button>
    </ion-buttons> 
    <ion-buttons *ngIf="ajoutForm || modifierFrom || statistique" left>
      <button ion-button icon-only color="royal" (click)="annuler()"> <ion-icon name="arrow-back"></ion-icon></button>
    </ion-buttons> 
    <ion-buttons *ngIf="detailEssai" left>
      <button ion-button icon-only color="royal" (click)="fermerDetail()"><ion-icon name="arrow-back"></ion-icon></button>
    </ion-buttons> 
    <ion-buttons *ngIf="!ajoutForm && !detailEssai && !modifierFrom && !statistique"  start>

      <button ion-button *ngIf="rechercher" icon-only>
          <ion-spinner></ion-spinner>
      </button>

      <button ion-button icon-only>
        <ion-badge color="fuma-green" item-right><span *ngIf="selectedStyleTableau == 'standard'"> {{essais.length}}</span> <span *ngIf="selectedStyleTableau == 'avance'"> {{essais.length *2}}</span></ion-badge>
      </button>

      <button ion-button icon-only color="royal" *ngIf="aProfile" (click) = "sync()" >
         <ion-icon name="sync"></ion-icon>
      </button>

      <button ion-button icon-only color="royal" *ngIf="aProfile" (click) = "replicationDepuisServeur()" >
         <ion-icon name="arrow-round-down"></ion-icon>
      </button>

      <button ion-button icon-only color="royal" *ngIf="aProfile" (click) = "replicationVersServeur()" >
         <ion-icon name="arrow-round-up"></ion-icon>
      </button>

      <!--button ion-button icon-only color="royal" (click) = "copierDB()" >
         <ion-icon name="arrow-dropup-circle"></ion-icon>
      </button-->

      <button *ngIf="aProfile" ion-button icon-only color="royal"  (click)="profile()">
        <ion-icon name="person"></ion-icon>
      </button>

      <button *ngIf="!aProfile" ion-button icon-only color="royal" (click)="connexion()">
        <ion-icon name="unlock"></ion-icon>
      </button>
    </ion-buttons>

    <ion-title *ngIf="!ajoutForm && !detailEssai">essai</ion-title>
    <ion-title *ngIf="ajoutForm && !modifierFrom">ajouter-essai</ion-title>
    <ion-title *ngIf="ajoutForm && modifierFrom">modifier-essai</ion-title>
    <ion-title *ngIf="detailEssai">detail-essai</ion-title>

    <ion-buttons *ngIf="!ajoutForm && !detailEssai && !modifierFrom"  end>
      
      <button ion-button icon-only color="royal" (click)="option()"><ion-icon name="options"></ion-icon></button>
    </ion-buttons>
  </ion-navbar>

</ion-header>


<ion-content padding>


  <ion-refresher *ngIf="!ajoutForm && !detailEssai && !modifierFrom" (ionRefresh)="getEssais($event)">
    <ion-refresher-content
      pullingIcon="arrow-dropdown"
      pullingText="Tirer pour actualiser"
      refreshingSpinner="circles"
      refreshingText="Actualisation...">
    </ion-refresher-content>
  </ion-refresher>

<div *ngIf="!ajoutForm && !detailEssai && !statistique">

  <ion-list>
    <ion-row>
      <ion-col>
        <ion-item>
          <ion-label floating>Choisir l'année</ion-label>
          <ion-select [(ngModel)]="selectedAnnee" (ionChange)="choixAnneeEssai(selectedAnnee, true)" cancelText="Annuler" okText="Ok" >
            <ion-option value="" selected disabled>Selectionnez l'année</ion-option>
            <ion-option *ngFor="let anne of annees" [value]=anne>{{anne}}</ion-option>
          </ion-select>
        </ion-item>
      </ion-col>
      <ion-col>
        <ion-item>
          <ion-label floating>Choisir la limite</ion-label>
          <ion-select [(ngModel)]="selectedLimit" (ionChange)="choixLimit()" cancelText="Annuler" okText="Ok" >
            <ion-option value="" selected disabled>Selectionnez la limite</ion-option>
            <ion-option *ngFor="let limit of limits" [value]=limit>{{limit}}</ion-option>
          </ion-select>
        </ion-item>
      </ion-col>
    </ion-row>

    <ion-item *ngIf="!selectedProtocole1 || selectedProtocole1.type_culture != 'association'">
        <ion-label floating>Choisir le protocole</ion-label>
        <ion-select [(ngModel)]="indexSelectedProtocole" (ionChange)="protocoleSelected(indexSelectedProtocole)" cancelText="Annuler" okText="Ok" >
          <ion-option value="" selected disabled>Selectionnez k le protocole</ion-option>
          <ion-option *ngFor="let prot of protocoles; let i = index" [value]=i>{{prot.doc.data.nom}}</ion-option>
        </ion-select>
      </ion-item>

    <ion-row *ngIf="selectedProtocole1 && selectedProtocole1.type_culture == 'association'">
      <ion-col>
        <ion-item>
          <ion-label floating>Choisir le protocole</ion-label>
          <ion-select [(ngModel)]="indexSelectedProtocole" (ionChange)="protocoleSelected(indexSelectedProtocole)" cancelText="Annuler" okText="Ok" >
            <ion-option value="" selected disabled>Selectionnez le protocole</ion-option>
            <ion-option *ngFor="let prot of protocoles; let i = index" [value]=i>{{prot.doc.data.nom}}</ion-option>
          </ion-select>
        </ion-item>
      </ion-col>
      <ion-col>
        <ion-item>
          <ion-label floating>Choisir la culture</ion-label>
          <ion-select [(ngModel)]="indexSelectedCultureProtocole" (ionChange)="getEssaisByProtocoleAndCulture()" cancelText="Annuler" okText="Ok" >
            <ion-option value="" selected disabled>Selectionnez la culture</ion-option>
            <ion-option *ngFor="let cult of culturesProtocole; let i = index" [value]=i>{{cult.doc.data.nom_culture}}</ion-option>
          </ion-select>
        </ion-item>
      </ion-col>
    </ion-row>

    <ion-row *ngIf="selectedStyle === 'tableau'">
      <ion-col>
        <ion-item>
          <ion-label floating>Style affichage</ion-label>
          <ion-select [(ngModel)]="selectedStyle" cancelText="Annuler" okText="Ok" >
            <ion-option value="" selected disabled>Selectionnez le style de la liste</ion-option>
            <ion-option value="liste" >Liste</ion-option>
            <ion-option value="tableau" >Tableau</ion-option>
          </ion-select>
        </ion-item>
      </ion-col>
      <ion-col>
        <ion-item>
          <ion-label floating>Style de tableau</ion-label>
          <ion-select [(ngModel)]="selectedStyleTableau" cancelText="Annuler" okText="Ok" >
            <ion-option value="standard" >Standard</ion-option>
            <!--ion-option value="avance" >Décompacté</ion-option-->
            <ion-option value="tres-avance" >Très décompacté</ion-option>
          </ion-select>
        </ion-item>
      </ion-col>
    </ion-row>

    <ion-item *ngIf="selectedStyle !== 'tableau'">
      <ion-label floating>Style affichage</ion-label>
      <ion-select [(ngModel)]="selectedStyle" cancelText="Annuler" okText="Ok" >
        <ion-option value="" selected disabled>Selectionnez le style de la liste</ion-option>
        <ion-option value="liste" >Liste</ion-option>
        <ion-option value="tableau" >Tableau</ion-option>
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-label floating>Type de recherche</ion-label>
      <ion-select [(ngModel)]="typeRecherche" (ionChange)="typeRechercheChange()" cancelText="Annuler" okText="Ok" >
        <ion-option value="matricule" >Par matricule membre</ion-option>
        <ion-option value="nom_membre" >Par nom membre</ion-option>
        <ion-option value="surnom_membre" >Par surnom membre</ion-option>
        <ion-option value="nom_entree" >Par nom entrée</ion-option>
        <ion-option value="type_sole" >Par type sole</ion-option>
        <ion-option value="site" >Par site</ion-option>
        <ion-option value="village" >Par village</ion-option>
      </ion-select>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'matricule'">
      <ion-searchbar placeholder="Rechercher mat. producteur..." [(ngModel)]="recherche" [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'nom_membre'">
      <ion-searchbar placeholder="Rechercher nom producteur..."  [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'surnom_membre'">
      <ion-searchbar placeholder="Rechercher surnom producteur..." [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'type_sole'">
      <ion-searchbar placeholder="Rechercher type sole..." [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'site'">
      <ion-searchbar placeholder="Rechercher site..." [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'village'">
      <ion-searchbar placeholder="Rechercher village..." [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>

    <ion-item *ngIf="typeRecherche == 'nom_entree'">
      <ion-searchbar placeholder="Rechercher nom entrée..." [showCancelButton]="shouldShowCancel" (ionInput)="getItems($event)"></ion-searchbar>
    </ion-item>
  </ion-list>
  
   <br >
    <ion-list class="info-card" *ngIf="essais.length > 0 && selectedStyle === 'liste'">
    <!--ion-list *ngIf="selectedStyle === 'liste'" [virtualScroll]="essais" [headerFn]="myHeaderFn"-->
     
      <ion-list-header>
        <h2  class="fond-gris"><strong>Les essais {{selectedAnnee}} <span *ngIf="matricule_producteur1 && selectedStyle == 'liste'">
    de {{nom_producteur1}} - mat. {{matricule_producteur1}}
  </span></strong></h2>
      </ion-list-header>

      <!--ion-item-divider *virtualHeader="let header" class="message">
        <strong style="width: 100%" >Essais {{selectedAnnee}}: {{header}}</strong>
      </ion-item-divider-->

      <ion-item-sliding *ngFor="let ess of essais; let i = index">
        <ion-item (click)="detail(ess.doc)"> 
        <!--ion-item *virtualItem="let ess" (click)="detail(ess.doc)" --> 
          <!--h6><strong>Code essai:</strong> {{ess.doc.data.code_essai}}</h6-->
          <h6><strong>Mat. producteur:</strong> {{ess.doc.data.matricule_producteur}}</h6>
          <h6><strong>Nom producteur:</strong> {{ess.doc.data.nom_producteur}} <span *ngIf="ess.doc.data.surnom_producteur">({{ess.doc.data.surnom_producteur}})</span> </h6>
          <h6 *ngIf="selectedProtocole1.avec_systeme == 'oui'"><strong>Système:</strong> S{{ess.doc.data.systeme}}</h6>
          <h6 *ngIf="selectedProtocole1.avec_bloc == 'oui'"><strong>Bloc:</strong> B{{ess.doc.data.bloc}}</h6>
          <h6 *ngIf="selectedProtocole1.avec_parcelle == 'oui'"><strong>Parcelle:</strong> P{{ess.doc.data.parcelle}}</h6>
          <h6 *ngIf="selectedProtocole1.avec_repetition == 'oui'"><strong>Repetition:</strong> R{{ess.doc.data.repetition}}</h6>
          <!--h6 *ngIf="selectedProtocole1.avec_parcelle == 'non'"><strong>Variété(s):</strong> {{ess.doc.data.cultures[0].variete}} <span *ngIf="selectedProtocole1.type_culture == 'association' && ess.doc.data.cultures[1]">, {{ess.doc.data.cultures[1].variete}}</span> </h6-->
          <h6 *ngIf="selectedProtocole1.traitement == 'oui'"><strong>Entrée(s):</strong> {{ess.doc.data.nom_entree}}</h6>

        </ion-item>
        <ion-item-options *ngIf="(user && user.roles && global.estManager(user.roles)) || estManger" side="right">
          <button ion-button icon-only color="my_primary" (click)="partager(ess.doc._id)">
            <ion-icon name="share"></ion-icon>
          </button>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>

  <ion-card class="info-card" *ngIf="essais.length > 0 && selectedStyle === 'tableau'">
    <ion-card-header>
      <h2 class="fond-gris"><strong>Les essais {{selectedAnnee}} <span *ngIf="matricule_producteur1">
    de {{nom_producteur1}} - mat. {{matricule_producteur1}}
  </span></strong></h2>
    </ion-card-header> 
    <ion-scroll scrollX="true" scrollY="true" id="tableau" style="height: 80vh"> 

    <table  id="tableau1" class="table table-striped table-bordered" *ngIf="selectedProtocole1.type_culture == 'association' && selectedStyleTableau == 'standard'">
      <thead>
        <!--tr>
          <th colspan="1">
            
          </th>
          <th colspan="7" style="text-align: center; font-style: bold">
            Info membre
          </th>
          <th colspan="4">
            Info champ
          </th>
        </tr-->
        <tr>
        <th style="min-width: 150px" >
          <strong>Code essai</strong> 
        </th>
        <th >
          <strong>Code union</strong> 
        </th>
        <th  >
          <strong>Site</strong>
        </th>
        <th>
          <strong>Village</strong>
        </th>
        <th style="min-width: 105px" >
          <strong>Matricule producteur</strong>
        </th>
        <th style="min-width: 130px" >
          <strong>Nom producteur (surnom)</strong>
        </th>
        <th  >
          <strong>Sex</strong>
        </th>
        <th  >
          <strong>Classes</strong>
        </th>
        <th  style="min-width: 100px">
          <strong>Nom du champs</strong>
        </th>
        <th style="min-width: 100px" >
          <strong>Type de sole</strong>
        </th>
        <th  >
          <strong>Latitude</strong>
        </th>
        <th  >
          <strong>Longitude</strong>
        </th>

        <th  style="min-width: 100px" *ngIf="selectedProtocole1.traitement == 'oui'">
            <strong>Nom d'entrée</strong>
        </th>
        <!--th  style="min-width: 100px" *ngIf="selectedProtocole1.traitement == 'oui'">
          <strong>Nom d'entrée</strong>
        </th-->

        <!--th style="min-width: 120px" *ngIf="selectedProtocole1.traitement == 'oui' && selectedProtocole1.type_essais == 'avec controle'">
          <strong>Nom controle</strong>
        </th-->

        <!--th>
          <strong>Superficie essai (m²)</strong>
        </th-->

        <!--th *ngIf="selectedProtocole1.avec_code_association == 'oui'">
          <strong>Code association</strong>
        </th-->
        <th *ngIf="selectedProtocole1.avec_systeme == 'oui'">
          <strong>Système</strong>
        </th>
        <th *ngIf="selectedProtocole1.avec_bloc == 'oui'">
          <strong>Bloc</strong>
        </th>
        <th *ngIf="selectedProtocole1.avec_parcelle == 'oui'">
          <strong>Parcelle</strong>
        </th>
        <th *ngIf="selectedProtocole1.avec_repetition == 'oui'">
          <strong>Répétition</strong>
        </th>  
        <!--th style="min-width: 80px">
          <strong>Culture 1</strong>
        </th-->
        <th style="min-width: 100px">
          <strong>Variété {{essais[0].doc.data.cultures[0].culture}}</strong>
        </th>

        <th style="min-width: 100px">
          <strong>Superficie essai {{essais[0].doc.data.cultures[0].culture}} (m²)</strong>
        </th>
  

        <th style="min-width: 50px" *ngFor="let vr of  essais[0].doc.data.cultures[0].variables_essai">
          <strong>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''">({{vr.unite}})</span> </strong>
        </th>

        <!--th style="min-width: 80px">
          <strong>Culture 2</strong>
        </th-->
        <th style="min-width: 100px">
          <strong>Variété {{essais[0].doc.data.cultures[1].culture}}</strong>
        </th>

        <th style="min-width: 100px">
          <strong>Superficie essai {{essais[0].doc.data.cultures[1].culture}} (m²)</strong>
        </th>
  

        <th style="min-width: 50px" *ngFor="let vr of essais[0].doc.data.cultures[1].variables_essai">
          <strong>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''">({{vr.unite}})</span> </strong>
        </th>
        
        <th  >
          <strong>Effort personnel ?</strong> 
        </th>
        <th  >
          <strong>Est valide ?</strong> 
        </th>
        </tr>
      </thead>
      <!--hr style="width: 375%"-->
      <tbody *ngFor="let ess of essais">
          <tr (click)="detail(ess.doc)">
            <td  >
              {{ess.doc.data.code_essai}}
            </td>
            <td  >
              {{ess.doc.data.code_union}}
            </td>
            <td  >
              {{ess.doc.data.site_producteur}}
            </td>
            <td  >
              {{ess.doc.data.village_producteur}}
            </td>
            <td  >
              {{ess.doc.data.matricule_producteur}}
            </td>
            <td  >
              {{ess.doc.data.nom_producteur}} <span *ngIf="ess.doc.data.surnom_producteur">({{ess.doc.data.surnom_producteur}})</span>
            </td>
            <td  >
              <span *ngIf="ess.doc.data.sex_producteur == 'male'">Homme</span><span *ngIf="ess.doc.data.sex_producteur == 'female'">Femme</span>
            </td>
            <td  >
              <span *ngFor="let c of ess.doc.data.classes_producteur; let i = index"> {{c}}<span *ngIf="i < ess.doc.data.classes_producteur.length - 1">, </span> </span>
            </td>
            <td  >
              {{ess.doc.data.nom_champs}}
            </td>
            <td  >
              {{ess.doc.data.type_sole}}
            </td>
            <td  >
              {{ess.doc.data.latitude}}
            </td>
            <td  >
              {{ess.doc.data.longitude}}
            </td>
            <td *ngIf="selectedProtocole1.traitement == 'oui'">
                {{ess.doc.data.nom_entree}}
            </td>
           
            <!--td *ngIf="selectedProtocole1.avec_code_association == 'oui'">
              {{ess.doc.data.code_association}}
            </td-->
            <td *ngIf="selectedProtocole1.avec_systeme == 'oui'">
              S{{ess.doc.data.systeme}}
            </td>
            <td *ngIf="selectedProtocole1.avec_bloc == 'oui'">
              B{{ess.doc.data.bloc}}
            </td>
            <td *ngIf="selectedProtocole1.avec_parcelle == 'oui'">
              P{{ess.doc.data.parcelle}}
            </td>
            <td *ngIf="selectedProtocole1.avec_repetition == 'oui'">
              R{{ess.doc.data.repetition}}
            </td>

            <!--th>
              {{ess.doc.data.cultures[0].culture}}
            </th-->
            <td>
              {{ess.doc.data.cultures[0].variete}}
            </td>

            <td >
              {{ess.doc.data.cultures[0].superficie_essai}}
            </td>
    
            <td *ngFor="let vr of ess.doc.data.cultures[0].variables_essai; let i = index">
                <span *ngIf="vr.type_variable != 'date'">{{vr.valeur_variable}}</span> <span *ngIf="vr.type_variable == 'date'">{{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span> 
            </td>

            <!--th>
                {{ess.doc.data.cultures[1].culture}}
              </th-->
              <td>
                {{ess.doc.data.cultures[1].variete}}
              </td>

              <td >
                {{ess.doc.data.cultures[1].superficie_essai}}
              </td>
      
              <td *ngFor="let vr of ess.doc.data.cultures[1].variables_essai; let i = index">
                  <span *ngIf="vr.type_variable != 'date'">{{vr.valeur_variable}}</span> <span *ngIf="vr.type_variable == 'date'">{{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span> 
              </td>

            <td  >
              <span *ngIf="ess.doc.data.effort_personnel">Oui</span><span *ngIf="!ess.doc.data.effort_personnel">Non</span>
            </td>
            <td  >
              <span *ngIf="ess.doc.data.estValide">Oui</span><span *ngIf="!ess.doc.data.estValide">Non</span>
            </td>          
          </tr>

          <tr *ngIf="ess.doc.data.type_essais == 'avec controle'" (click)="detail(ess.doc)">
              <td  >
                {{ess.doc.data.code_essai}}
              </td>
              <td  >
                {{ess.doc.data.code_union}}
              </td>
              <td  >
                {{ess.doc.data.site_producteur}}
              </td>
              <td  >
                {{ess.doc.data.village_producteur}}
              </td>
              <td  >
                {{ess.doc.data.matricule_producteur}}
              </td>
              <td  >
                {{ess.doc.data.nom_producteur}} <span *ngIf="ess.doc.data.surnom_producteur">({{ess.doc.data.surnom_producteur}})</span>
              </td>
              <td  >
                <span *ngIf="ess.doc.data.sex_producteur == 'male'">Homme</span><span *ngIf="ess.doc.data.sex_producteur == 'female'">Femme</span>
              </td>
              <td  >
                <span *ngFor="let c of ess.doc.data.classes_producteur; let i = index"> {{c}}<span *ngIf="i < ess.doc.data.classes_producteur.length - 1">, </span> </span>
              </td>
              <td  >
                {{ess.doc.data.nom_champs}}
              </td>
              <td  >
                {{ess.doc.data.type_sole}}
              </td>
              <td  >
                {{ess.doc.data.latitude}}
              </td>
              <td  >
                {{ess.doc.data.longitude}}
              </td>
              <!--td  *ngIf="selectedProtocole1.traitement == 'oui'">
                {{ess.doc.data.nom_entree}}
              </td-->
              <!--td *ngIf="selectedProtocole1.traitement == 'oui' && selectedProtocole1.type_essais == 'avec controle'">
                {{ess.doc.data.nom_controle}}
              </td-->
              <td *ngIf="selectedProtocole1.traitement == 'oui'">
                {{ess.doc.data.nom_controle}}
              </td>
              <!--td *ngIf="selectedProtocole1.avec_code_association == 'oui'">
                {{ess.doc.data.code_association}}
              </td-->
              <td *ngIf="selectedProtocole1.avec_systeme == 'oui'">
                S{{ess.doc.data.systeme}}
              </td>
              <td *ngIf="selectedProtocole1.avec_bloc == 'oui'">
                B{{ess.doc.data.bloc}}
              </td>
              <td *ngIf="selectedProtocole1.avec_parcelle == 'oui'">
                P{{ess.doc.data.parcelle}}
              </td>
              <td *ngIf="selectedProtocole1.avec_repetition == 'oui'">
                R{{ess.doc.data.repetition}}
              </td>
  
              <!--th>
                {{ess.doc.data.cultures[0].culture}}
              </th-->
              <td>
                {{ess.doc.data.cultures[0].variete}}
              </td>

              <td >
                {{ess.doc.data.cultures[0].superficie_controle}}
              </td>
      
              <td *ngFor="let vr of ess.doc.data.cultures[0].variables_controle; let i = index">
                  <span *ngIf="vr.type_variable != 'date'">{{vr.valeur_variable}}</span> <span *ngIf="vr.type_variable == 'date'">{{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span> 
              </td>
  
              <!--th>
                  {{ess.doc.data.cultures[1].culture}}
                </th-->
                <td>
                  {{ess.doc.data.cultures[1].variete}}
                </td>

                <td >
                  {{ess.doc.data.cultures[1].superficie_controle}}
                </td>
        
                <td *ngFor="let vr of ess.doc.data.cultures[1].variables_controle; let i = index">
                    <span *ngIf="vr.type_variable != 'date'">{{vr.valeur_variable}}</span> <span *ngIf="vr.type_variable == 'date'">{{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span> 
                </td>
  
              <td  >
                <span *ngIf="ess.doc.data.effort_personnel">Oui</span><span *ngIf="!ess.doc.data.effort_personnel">Non</span>
              </td>
              <td  >
                <span *ngIf="ess.doc.data.estValide">Oui</span><span *ngIf="!ess.doc.data.estValide">Non</span>
              </td>          
            </tr>
      </tbody>
    </table>


    <!-- Pour les non association  -->
    <table  id="tableau1" class="table table-striped table-bordered" *ngIf="selectedProtocole1.type_culture != 'association' && selectedStyleTableau == 'standard'">
        <thead >
          <!--tr>
            <th colspan="1">
              
            </th>
            <th colspan="7" style="text-align: center; font-style: bold">
              Info membre
            </th>
            <th colspan="4">
              Info champ
            </th>
          </tr-->
          <tr>
          <th style="min-width: 150px" >
            <strong>Code essai</strong> 
          </th>
          <th >
            <strong>Code union</strong> 
          </th>
          <th  >
            <strong>Site</strong>
          </th>
          <th>
            <strong>Village</strong>
          </th>
          <th style="min-width: 105px" >
            <strong>Matricule producteur</strong>
          </th>
          <th style="min-width: 130px" >
            <strong>Nom producteur (surnom)</strong>
          </th>
          <th  >
            <strong>Sex</strong>
          </th>
          <th  >
            <strong>Classes</strong>
          </th>
          <th  style="min-width: 100px">
            <strong>Nom du champs</strong>
          </th>
          <th style="min-width: 100px" >
            <strong>Type de sole</strong>
          </th>
          <th  >
            <strong>Latitude</strong>
          </th>
          <th  >
            <strong>Longitude</strong>
          </th>
  
          <th  style="min-width: 100px" *ngIf="selectedProtocole1.traitement == 'oui'">
              <strong>Nom d'entrée</strong>
            </th>
  
            <!--th *ngIf="selectedProtocole1.avec_code_association == 'oui'">
              <strong>Code association</strong>
            </th-->
            <th *ngIf="selectedProtocole1.avec_systeme == 'oui'">
              <strong>Système</strong>
            </th>
          <th *ngIf="selectedProtocole1.avec_bloc == 'oui'">
            <strong>Bloc</strong>
          </th>
          <th *ngIf="selectedProtocole1.avec_parcelle == 'oui'">
            <strong>Parcelle</strong>
          </th>
          <th *ngIf="selectedProtocole1.avec_repetition == 'oui'">
            <strong>Répétition</strong>
          </th>
  
            
          <!--th style="min-width: 80px">
            <strong>Culture</strong>
          </th-->
          <th style="min-width: 100px">
            <strong>Variété {{essais[0].doc.data.cultures[0].culture}}</strong>
          </th>

          <th style="min-width: 100px">
            <strong>Superficie essai {{essais[0].doc.data.cultures[0].culture}} (m²)</strong>
          </th>
  
          <th style="min-width: 50px" *ngFor="let vr of  essais[0].doc.data.cultures[0].variables_essai">
            <strong>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''">({{vr.unite}})</span> </strong>
          </th>        
          <th  >
            <strong>Effort personnel ?</strong> 
          </th>
          <th  >
            <strong>Est valide ?</strong> 
          </th>
          </tr>
        </thead>
        <!--hr style="width: 375%"-->
        <tbody *ngFor="let ess of essais">
            <tr (click)="detail(ess.doc)">
              <td  >
                {{ess.doc.data.code_essai}}
              </td>
              <td  >
                {{ess.doc.data.code_union}}
              </td>
              <td  >
                {{ess.doc.data.site_producteur}}
              </td>
              <td  >
                {{ess.doc.data.village_producteur}}
              </td>
              <td  >
                {{ess.doc.data.matricule_producteur}}
              </td>
              <td  >
                {{ess.doc.data.nom_producteur}} <span *ngIf="ess.doc.data.surnom_producteur">({{ess.doc.data.surnom_producteur}})</span>
              </td>
              <td  >
                <span *ngIf="ess.doc.data.sex_producteur == 'male'">Homme</span><span *ngIf="ess.doc.data.sex_producteur == 'female'">Femme</span>
              </td>
              <td  >
                <span *ngFor="let c of ess.doc.data.classes_producteur; let i = index"> {{c}}<span *ngIf="i < ess.doc.data.classes_producteur.length - 1">, </span> </span>
              </td>
              <td  >
                {{ess.doc.data.nom_champs}}
              </td>
              <td  >
                {{ess.doc.data.type_sole}}
              </td>
              <td  >
                {{ess.doc.data.latitude}}
              </td>
              <td  >
                {{ess.doc.data.longitude}}
              </td>
              <td *ngIf="selectedProtocole1.traitement == 'oui'">
                  {{ess.doc.data.nom_entree}}
              </td>
              <!--td *ngIf="selectedProtocole1.avec_code_association == 'oui'">
                {{ess.doc.data.code_association}}
              </td-->
              <td *ngIf="selectedProtocole1.avec_systeme == 'oui'">
                S{{ess.doc.data.systeme}}
              </td>
              <td *ngIf="selectedProtocole1.avec_bloc == 'oui'">
                B{{ess.doc.data.bloc}}
              </td>
              <td *ngIf="selectedProtocole1.avec_parcelle == 'oui'">
                P{{ess.doc.data.parcelle}}
              </td>
              <td *ngIf="selectedProtocole1.avec_repetition == 'oui'">
                R{{ess.doc.data.repetition}}
              </td>
  
              <!--th>
                {{ess.doc.data.cultures[0].culture}}
              </th-->
              <td>
                {{ess.doc.data.cultures[0].variete}}
              </td>

              <td >
                {{ess.doc.data.cultures[0].superficie_essai}}
              </td>
      
              <td *ngFor="let vr of ess.doc.data.cultures[0].variables_essai; let i = index">
                  <span *ngIf="vr.type_variable != 'date'">{{vr.valeur_variable}}</span> <span *ngIf="vr.type_variable == 'date'">{{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span> 
              </td>
  
              <td  >
                <span *ngIf="ess.doc.data.effort_personnel">Oui</span><span *ngIf="!ess.doc.data.effort_personnel">Non</span>
              </td>
              <td  >
                <span *ngIf="ess.doc.data.estValide">Oui</span><span *ngIf="!ess.doc.data.estValide">Non</span>
              </td>          
            </tr>
  
            <tr *ngIf="ess.doc.data.type_essais == 'avec controle'" (click)="detail(ess.doc)">
                <td  >
                  {{ess.doc.data.code_essai}}
                </td>
                <td  >
                  {{ess.doc.data.code_union}}
                </td>
                <td  >
                  {{ess.doc.data.site_producteur}}
                </td>
                <td  >
                  {{ess.doc.data.village_producteur}}
                </td>
                <td  >
                  {{ess.doc.data.matricule_producteur}}
                </td>
                <td  >
                  {{ess.doc.data.nom_producteur}} <span *ngIf="ess.doc.data.surnom_producteur">({{ess.doc.data.surnom_producteur}})</span>
                </td>
                <td  >
                  <span *ngIf="ess.doc.data.sex_producteur == 'male'">Homme</span><span *ngIf="ess.doc.data.sex_producteur == 'female'">Femme</span>
                </td>
                <td  >
                  <span *ngFor="let c of ess.doc.data.classes_producteur; let i = index"> {{c}}<span *ngIf="i < ess.doc.data.classes_producteur.length - 1">, </span> </span>
                </td>
                <td  >
                  {{ess.doc.data.nom_champs}}
                </td>
                <td  >
                  {{ess.doc.data.type_sole}}
                </td>
                <td  >
                  {{ess.doc.data.latitude}}
                </td>
                <td  >
                  {{ess.doc.data.longitude}}
                </td>
                <!--td  *ngIf="selectedProtocole1.traitement == 'oui'">
                  {{ess.doc.data.nom_entree}}
                </td-->
                <!--td *ngIf="selectedProtocole1.traitement == 'oui' && selectedProtocole1.type_essais == 'avec controle'">
                  {{ess.doc.data.nom_controle}}
                </td-->
                <td *ngIf="selectedProtocole1.traitement == 'oui'">
                  {{ess.doc.data.nom_controle}}
                </td>
                <!--td *ngIf="selectedProtocole1.avec_code_association == 'oui'">
                  {{ess.doc.data.code_association}}
                </td-->
                <td *ngIf="selectedProtocole1.avec_systeme == 'oui'">
                  S{{ess.doc.data.systeme}}
                </td>
                <td *ngIf="selectedProtocole1.avec_bloc == 'oui'">
                  B{{ess.doc.data.bloc}}
                </td>
                <td *ngIf="selectedProtocole1.avec_parcelle == 'oui'">
                  P{{ess.doc.data.parcelle}}
                </td>
                <td *ngIf="selectedProtocole1.avec_repetition == 'oui'">
                  R{{ess.doc.data.repetition}}
                </td>
    
                <!--th>
                  {{ess.doc.data.cultures[0].culture}}
                </th-->
                <td>
                  {{ess.doc.data.cultures[0].variete}}
                </td>

                <td >
                    {{ess.doc.data.cultures[0].superficie_controle}}
                  </td>
        
                <td *ngFor="let vr of ess.doc.data.cultures[0].variables_controle; let i = index">
                    <span *ngIf="vr.type_variable != 'date'">{{vr.valeur_variable}}</span> <span *ngIf="vr.type_variable == 'date'">{{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span> 
                </td>
    
                <td  >
                  <span *ngIf="ess.doc.data.effort_personnel">Oui</span><span *ngIf="!ess.doc.data.effort_personnel">Non</span>
                </td>
                <td  >
                  <span *ngIf="ess.doc.data.estValide">Oui</span><span *ngIf="!ess.doc.data.estValide">Non</span>
                </td>          
              </tr>
        </tbody>
      </table>
  </ion-scroll>
</ion-card>

<div *ngIf="essais.length > 0">
  <br><br><br><br>
</div>
   <ion-list *ngIf="!essais.length > 0">
    <ion-item>
      <div class="message">La liste est vide!</div>
    </ion-item>    
  </ion-list>

  <!--ion-fab bottom right *ngIf="essais.length > 0 && selectedStyle == 'tableau'">
    <button ion-fab mini (click)="onPrint()"><ion-icon name="print"></ion-icon></button->
    <button ion-fab mini (click)="exportXLSX()"><ion-icon name="cloud-upload"></ion-icon></button>
</ion-fab-->

</div>

<div *ngIf="detailEssai">
    <ion-card class="info-card" (dblclick)="editer(essai, true)"> 
      <ion-card-header>
        <h2 class="fond-gris"><strong>Détail Essai: {{essai.data.code_essai}}</strong></h2>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row><h5 class="sans-fond-gris"><strong>Infos généraux</strong></h5> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Code essai:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.code_essai}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Année:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.annee_essai}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Protocole:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.nom_protocole}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Type de culture:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.type_culture}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Type des essais:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.type_essais}} </ion-col> </ion-row>
          <!--ion-row> <ion-col class='meta-key'><strong>Traitement:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.traitement}} </ion-col> </ion-row-->
          <ion-row *ngIf="essai.data.code_association"> <ion-col class='meta-key'><strong>Code association:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.code_association}} </ion-col> </ion-row>
          <ion-row *ngIf="essai.data.systeme"> <ion-col class='meta-key'><strong>Système:</strong></ion-col> <ion-col class='meta-value'> S{{essai.data.systeme}} </ion-col> </ion-row>
          <ion-row *ngIf="essai.data.bloc"> <ion-col class='meta-key'><strong>Bloc:</strong></ion-col> <ion-col class='meta-value'> B{{essai.data.bloc}} </ion-col> </ion-row>
          <ion-row *ngIf="essai.data.parcelle"> <ion-col class='meta-key'><strong>Parcelle:</strong></ion-col> <ion-col class='meta-value'> P{{essai.data.parcelle}} </ion-col> </ion-row>
          <ion-row *ngIf="essai.data.repetition"> <ion-col class='meta-key'><strong>Répétition:</strong></ion-col> <ion-col class='meta-value'> R{{essai.data.repetition}} </ion-col> </ion-row>
          <ion-row *ngIf="essai.data.traitement == 'non'"> <ion-col class='meta-key'><strong>Superficie standard (m²):</strong></ion-col> <ion-col class='meta-value'> {{essai.data.superficie_standard}}</ion-col> </ion-row>
          <ion-row><h5 class="sans-fond-gris"><strong>Info producteur</strong></h5> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Matricule producteur:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.matricule_producteur}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Nom producteur:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.nom_producteur}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Surnom producteur:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.surnom_producteur}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Sex producteur:</strong></ion-col> <ion-col class='meta-value'> <span *ngIf="essai.data.sex_producteur == 'male'">Homme</span><span *ngIf="essai.data.sex_producteur == 'female'">Femme</span> </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Code union:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.code_union}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Classe producteur:</strong></ion-col> <ion-col class='meta-value'><span *ngFor="let c of essai.data.classes_producteur; let i = index"> {{c}}<span *ngIf="i < essai.data.classes_producteur.length - 1">, </span> </span> </ion-col> </ion-row>
          <!--ion-row><h5 class="sans-fond-gris"><strong>Info localité</strong></h5> </ion-row-->
          <ion-row> <ion-col class='meta-key'><strong>Site:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.site_producteur}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Village:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.village_producteur}}</ion-col> </ion-row>
          <ion-row><h5 class="sans-fond-gris"><strong>Info champs</strong></h5> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>ID champs:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.id_champs}}</ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Nom champs:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.nom_champs}}</ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Type de sole:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.type_sole}}</ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Superficie:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.superficie}}ha</ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Latitude:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.latitude}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Longitude:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.longitude}}</ion-col> </ion-row>
          <div *ngIf="essai.data.traitement == 'oui'">
            <ion-row><h5 class="sans-fond-gris"><strong>Info triatement</strong></h5> </ion-row>
            <ion-row> <ion-col class='meta-key'><strong>Code traitement:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.code_traitement}} </ion-col> </ion-row>
            <ion-row> <ion-col class='meta-key'><strong>Nom d'entrée:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.nom_entree}} </ion-col> </ion-row>
            <ion-row *ngIf="essai.data.type_essais == 'avec controle'"> <ion-col class='meta-key'><strong>Nom controle:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.nom_controle}} </ion-col> </ion-row>
            <ion-row> <ion-col class='meta-key'><strong>Superficie standard (m²):</strong></ion-col> <ion-col class='meta-value'> {{essai.data.superficie_standard}}</ion-col> </ion-row>
          </div>
          
          <!--ion-row><h2 class="fond-gris"><strong>Données de l'essai</strong> </h2></ion-row-->
          <!--ion-row> <ion-col class='meta-key'><strong>Superficie essai:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.superficie_essai}}m²</ion-col> </ion-row-->
          <div *ngFor="let culture of essai.data.cultures">
              
              <ion-row><h5 class="sans-fond-gris"><strong>Culture de {{culture.culture}}</strong></h5> </ion-row>
              <!--ion-row> <ion-col class='meta-key'><strong>Culture:</strong></ion-col> <ion-col class='meta-value'> {{culture.culture}} </ion-col> </ion-row-->
              <ion-row> <ion-col class='meta-key'><strong>Variété:</strong></ion-col> <ion-col class='meta-value'> {{culture.variete}} </ion-col> </ion-row>
              <ion-row> <ion-col class='meta-key'><strong>Superficie essai en m²:</strong></ion-col> <ion-col class='meta-value'> {{culture.superficie_essai}}</ion-col> </ion-row>
              <ion-row *ngIf="essai.data.type_essais == 'avec controle'"> <ion-col class='meta-key'><strong>Superficie controle en m²:</strong></ion-col> <ion-col class='meta-value'> {{culture.superficie_controle}}</ion-col> </ion-row>
              <div *ngFor="let vr of culture.variables_essai; let i = index">
                <ion-row > <ion-col class='meta-key'><strong>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''">en {{vr.unite}}</span>:</strong></ion-col> <ion-col><span *ngIf="vr.type_variable != 'date'" class='meta-value' > {{vr.valeur_variable}} </span> <span *ngIf="vr.type_variable == 'date'" class='meta-value' > {{vr.valeur_variable | date: 'dd-MM-yyyy'}}</span></ion-col> </ion-row>
                <ion-row *ngIf="essai.data.type_essais == 'avec controle'"> <ion-col class='meta-key'><strong>{{culture.variables_controle[i].nom_variable}} controle <span *ngIf="culture.variables_controle[i].unite && culture.variables_controle[i].unite != ''">en {{culture.variables_controle[i].unite}}</span>:</strong></ion-col> <ion-col><span *ngIf="culture.variables_controle[i].type_variable != 'date'" class='meta-value' > {{culture.variables_controle[i].valeur_variable}} </span> <span *ngIf="culture.variables_controle[i].type_variable == 'date'" class='meta-value' > {{culture.variables_controle[i].valeur_variable | date: 'dd-MM-yyyy'}}</span></ion-col> </ion-row>
              </div>
              
          </div>
          <ion-row><h5 class="sans-fond-gris"><strong>Infos complémentaires</strong></h5> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Objectif de l'essai:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.objectif_essai}}</ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Gérant(s):</strong></ion-col> <ion-col class='meta-value'> <span *ngFor="let g of essai.data.gerants; let i = index">{{g}}<span *ngIf="i < essai.data.gerants.length - 1">, </span> </span></ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Culture(s) précédante(s):</strong></ion-col> <ion-col class='meta-value'> <span *ngFor="let pc  of essai.data.precedante_cultures; let i = index">{{pc}}<span *ngIf="i < essai.data.precedante_cultures.length - 1">, </span></span></ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Date enregistrement:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.today | date: 'dd-MM-yyyy'}}</ion-col> </ion-row>
          <ion-row><h5 class="sans-fond-gris"><strong>Status de l'essai</strong> </h5></ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Effort personnel ?:</strong></ion-col> <ion-col class='meta-value'> <span *ngIf="essai.data.effort_personnel == true">Oui</span><span *ngIf="essai.data.effort_personnel == false">Non</span></ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Est valide ?:</strong></ion-col> <ion-col class='meta-value'> <span *ngIf="essai.data.estValide == true">Oui</span><span *ngIf="essai.data.estValide == false">Non</span></ion-col> </ion-row>
          
        </ion-grid>
      </ion-card-content> 
    </ion-card>

    <ion-card class="info-card" *ngIf="(user && user.roles && global.estManager(user.roles)) || estManager" (dblclick)="editer(essai, true)"> 
      <ion-card-header>
        <h2 class="fond-gris"><strong>Plus d'informations</strong></h2>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row><ion-col class='meta-key'><strong>Id:</strong></ion-col> <ion-col class='meta-value'>{{essai._id}} </ion-col>   </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>No révision:</strong></ion-col> <ion-col class='meta-value'> {{essai._rev }} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Date création:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.created_at | date: 'dd-MM-yyyy'}} à {{essai.data.created_at | date: 'HH:mm:ss:ms'}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Créateur:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.created_by}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>ID appareil:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.deviceid}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Imei:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.imei}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Numéro téléphone:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.phonenumber}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Date dernière mise à jour:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.updatet_at | date: 'dd-MM-yyyy'}}  à {{essai.data.updatet_at | date: 'HH:mm:ss:ms'}}</ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Dernière mise à jour par:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.updated_by}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>ID appareil:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.update_deviceid}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Imei:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.update_imei}} </ion-col> </ion-row>
          <ion-row> <ion-col class='meta-key'><strong>Numéro téléphone:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.update_phonenumber}} </ion-col> </ion-row>
          <ion-row *ngIf="essai.data.deleted"> <ion-col class='meta-key'><strong>Date suppression:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.deleted_at | date: 'dd-MM-yyyy'}}  à {{essai.data.deleted_at | date: 'HH:mm:ss:ms'}}</ion-col> </ion-row>
          <ion-row *ngIf="essai.data.deleted"> <ion-col class='meta-key'><strong>Supprimé par:</strong></ion-col> <ion-col class='meta-value'> {{essai.data.deleted_by}} </ion-col> </ion-row>
        </ion-grid>
      </ion-card-content> 
    </ion-card>

  </div>

<div *ngIf="ajoutForm || modifierFrom">
  <!--h5 *ngIf="essais1.length > 0" style="text-align: center; color: seagreen">
    Essais: <span *ngFor="let ess of essais1">{{ess.doc.data.nom_entree}} - </span>
  </h5-->
     
<!--form [formGroup]="essaiForm" (ngSubmit) = "actionForm()"-->
<form (ngSubmit) = "actionForm()">
  
  <ion-item>
    <ion-label floating>Code essai <span class="error-box">*</span></ion-label>
    <ion-input type="text" name="code_essai" [(ngModel)]="Essai.code_essai" disabled></ion-input>
  </ion-item> 

  <ion-item>
    <ion-label floating>Date d'ajout <span class="error-box">*</span></ion-label>
    <!--ion-datetime displayFormat="DD/MM/YYYY" formControlName="today" [(ngModel)]="today" cancelText="Annuler" doneText="Valider"></ion-datetime-->
    <ion-datetime ion-datepicker  (ionChanged)="setDate($event);" [value]="dateAjout" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" [(ngModel)]="Essai.today" name="today" cancelText="Annuler" okText="Valider" disabled></ion-datetime>
  </ion-item>

  <!--span ion-datepicker  (ionChanged)="setDate($event);" [value]="local" full="false" calendar="true" locale="fr-FR" clear class="ScheduleDate" >
      <span>{{today | date}}<ion-icon name="clipboard" item-left></ion-icon></span>
    </span-->
    <br>
  <ion-row><h5 class="sans-fond-gris"><strong>Info protocole</strong></h5> </ion-row>
    
  <ion-item>
      <ion-label floating>Choisir l'année</ion-label>
      <ion-select name="annee_essai" [(ngModel)]="Essai.annee_essai" cancelText="Annuler" okText="Ok" (ionChange)="choixAnneeEssai(Essai.annee_essai)" >
        <ion-option value="" selected disabled>Selectionnez l'année</ion-option>
        <ion-option *ngFor="let anne of annees" [value]=anne>{{anne}}</ion-option>
      </ion-select>
    </ion-item>

    <ion-item *ngIf="!modifierFrom">
      <ion-label floating>Protocole <span class="error-box">*</span></ion-label>
      <ion-select [(ngModel)]="indexSelectedProtocoleAjout" name="protocole" (ionChange)="changerCultureProtocole(indexSelectedProtocoleAjout, false)" cancelText="Annuler" okText="Ok">
        <ion-option *ngFor="let pr of protocoles; let i = index" [value]=i>{{pr.doc.data.nom}}</ion-option>
      </ion-select>
    </ion-item>

    <ion-item *ngIf="modifierFrom">
      <ion-label floating>Modifier protocole <span class="error-box">*</span></ion-label>
      <ion-select [(ngModel)]="Essai.code_protocole" name="protocole" (ionChange)="changerCultureProtocoleCode(Essai.code_protocole, false)" cancelText="Annuler" okText="Ok">
        <ion-option *ngFor="let pr of protocoles" [value]=pr.doc.data.code>{{pr.doc.data.nom}}</ion-option>
      </ion-select>
    </ion-item>

    <ion-row>
      <ion-col>
        <ion-item>
          <ion-label floating>Type de culture <span class="error-box">*</span></ion-label>
          <ion-input type="text" name="type_culture" [(ngModel)]="Essai.type_culture" disabled></ion-input>
        </ion-item>
      </ion-col>
      <ion-col>
        <ion-item>
          <ion-label floating>Type des essais <span class="error-box">*</span></ion-label>
          <ion-input type="text" name="type_essais" [(ngModel)]="Essai.type_essais" disabled></ion-input>
        </ion-item>
      </ion-col>
    </ion-row>

    <!--ion-item *ngIf="selectedProtocole && selectedProtocole.avec_code_association == 'oui'">
      <ion-label floating>Code association <span class="error-box">*</span></ion-label>
      <ion-input type="text" name="code_association" [(ngModel)]="Essai.code_association"></ion-input>
    </ion-item--> 

    <ion-item *ngIf="selectedProtocole && selectedProtocole.avec_systeme == 'oui'">
      <ion-label floating>Système <span class="error-box">*</span></ion-label>
      <ion-select name="systeme" [(ngModel)]="Essai.systeme" cancelText="Annuler" okText="Ok">
        <ion-option value="" selected disabled>Selectionnez le système</ion-option>
        <ion-option *ngFor="let s of systemes" [value]=s >S{{s}}</ion-option>
      </ion-select> 
    </ion-item> 

    <ion-item *ngIf="selectedProtocole && selectedProtocole.avec_bloc == 'oui'">
      <ion-label floating>Bloc <span class="error-box">*</span></ion-label>
      <ion-select name="bloc" [(ngModel)]="Essai.bloc" cancelText="Annuler" okText="Ok">
        <ion-option value="" selected disabled>Selectionnez le bloc</ion-option>
        <ion-option *ngFor="let b of blocs" [value]=b >B{{b}}</ion-option>
      </ion-select> 
    </ion-item> 

    <ion-item *ngIf="selectedProtocole && selectedProtocole.avec_parcelle == 'oui'">
      <ion-label floating>Parcelle <span class="error-box">*</span></ion-label>
      <ion-select name="parcelle" [(ngModel)]="Essai.parcelle" cancelText="Annuler" okText="Ok">
        <ion-option value="" selected disabled>Selectionnez la parcelle</ion-option>
        <ion-option *ngFor="let i of parcelles" [value]=i >P{{i}}</ion-option>
      </ion-select> 
    </ion-item> 

    <ion-item *ngIf="selectedProtocole && selectedProtocole.avec_repetition == 'oui'">
      <ion-label floating>Répétition <span class="error-box">*</span></ion-label>
      <ion-select name="Essai.repetition" [(ngModel)]="Essai.repetition" cancelText="Annuler" okText="Ok">
        <ion-option value="" selected disabled>Selectionnez la répétition</ion-option>
        <ion-option *ngFor="let i of repetitions" [value]=i >R{{i}}</ion-option>
      </ion-select> 
    </ion-item> 

    <br>
    <ion-row><h5 class="sans-fond-gris"><strong>Info producteur</strong></h5> </ion-row>
  
    <ng-template  #withFlags let-attrs="attrs">
      <span [innerHTML]="attrs.data.matricule_Membre | boldprefix:attrs.keyword"></span> -- <span [innerHTML]="attrs.data.nom_Membre"></span>
    </ng-template>

      <ion-row *ngIf="!matricule_producteur1 && !modifierFrom">
        <ion-col>
          <ion-auto-complete [dataProvider]="ServiceAutoCompletion" [template]="withFlags" [options]="{ placeholder : 'Matricule producteur' }" (itemSelected)="itemSelected($event)" ></ion-auto-complete>  
        </ion-col>
      </ion-row>

      <!--ion-item *ngIf="matricule_producteur1">
        <ion-label floating>Matricule producteur <span class="error-box">*</span></ion-label>
        <ion-input type="text" formControlName="matricule_producteur" [(ngModel)]="matricule_producteur" disabled></ion-input>
      </ion-item--> 

      
      <ion-item *ngIf="(matricule_producteur1 && ajoutForm) || modifierFrom">
        <ion-label floating>Matricule producteur <span class="error-box">*</span></ion-label>
        <ion-input type="text" name="matricule_producteur" [(ngModel)]="Essai.matricule_producteur" disabled></ion-input>
      </ion-item> 

      <ion-item>
        <ion-label floating>Nom producteur <span class="error-box">*</span></ion-label>
        <ion-input type="text" name="nom_producteur" [(ngModel)]="Essai.nom_producteur" disabled></ion-input>
      </ion-item>
      
      <ion-item>
        <ion-label floating>Surnom producteur</ion-label>
        <ion-input type="text" name="surnom_producteur" [(ngModel)]="Essai.surnom_producteur" disabled></ion-input>
      </ion-item>

      <ion-item>
        <ion-label floating>Sex producteur <span class="error-box">*</span></ion-label>
        <ion-input type="text" name="sex_producteur" [(ngModel)]="Essai.sex_producteur" disabled></ion-input>
      </ion-item>
      
      <!--ion-item>
        <ion-label floating>Classe producteur</ion-label>
        <ion-input type="text" formControlName="classes_producteur" [(ngModel)]="classes_producteur" disabled></ion-input>
      </ion-item>
      <div style="padding-left: 15px;" class="error-box" *ngIf="essaiForm.controls['classes_producteur'].hasError('required') && essaiForm.controls['classes_producteur'].touched">* la classe du producteur est obligatoir!</div-->
      
      <ion-item>
        <ion-label floating>Site <span class="error-box">*</span></ion-label>
        <ion-input type="text" name="site_producteur" [(ngModel)]="Essai.site_producteur" disabled></ion-input>
      </ion-item>
      
      <ion-item>
        <ion-label floating>Village <span class="error-box">*</span></ion-label>
        <ion-input type="text" name="village_producteur" [(ngModel)]="Essai.village_producteur" disabled></ion-input>
      </ion-item>

      <br>
      <ion-row><h5 class="sans-fond-gris"><strong>Info champ</strong></h5> </ion-row>
      
      <ion-item *ngIf="!modifierFrom"> 
        <ion-label floating>Selectionnez le champs <span class="error-box">*</span></ion-label>
        <ion-select name="id_champs" [(ngModel)]="selectedChamps" cancelText="Annuler" okText="Ok" (ionChange)="chargerInfoChamps(selectedChamps.data)" >
          <ion-option value="" selected disabled>Selectionnez le champs</ion-option>
          <ion-option *ngFor="let c of champs" [value]=c.doc >{{c.doc.data.nom}}</ion-option>
        </ion-select> 
      </ion-item>
      
      <ion-item *ngIf="modifierFrom"> 
        <ion-label floating>Modifier le champs <span class="error-box">*</span></ion-label>
        <ion-select name="id_champs" [(ngModel)]="selectedChamps" cancelText="Annuler" okText="Ok" (ionChange)="chargerInfoChampsID(selectedChamps)" >
          <ion-option value="" selected disabled>Selectionnez le champs</ion-option>
          <ion-option *ngFor="let c of champs" [value]=c.doc.data.id_champs >{{c.doc.data.nom}}</ion-option>
        </ion-select> 
      </ion-item>
      
    <ion-row>
        <ion-col>
          <ion-item>
            <ion-label floating>Type de sole <span class="error-box">*</span></ion-label>
            <ion-input type="text" name="type_sole" [(ngModel)]="Essai.type_sole" disabled ></ion-input>
          </ion-item>
        </ion-col>
        <ion-col>
          <ion-item>
            <ion-label floating>Superficie (ha) <span class="error-box">*</span></ion-label>
            <ion-input type="number" name="superficie" [(ngModel)]="Essai.superficie" disabled ></ion-input>
          </ion-item>
        </ion-col>
    </ion-row>

    <ion-row>
      <ion-col>
        <ion-item>
          <ion-label floating>Latitude</ion-label>
          <ion-input type="text" name="latitude" [(ngModel)]="Essai.latitude" disabled></ion-input>
        </ion-item>
      </ion-col>
      <ion-col>
        <ion-item>
          <ion-label floating>Longitude</ion-label>
          <ion-input type="text" name="longitude" [(ngModel)]="Essai.longitude" disabled ></ion-input>
        </ion-item>
      </ion-col>
    </ion-row>

    <div *ngIf="Essai.traitement == 'oui'">
      <br>
      <ion-row><h5 class="sans-fond-gris"><strong>Info traitement</strong></h5> </ion-row>

      <!-->Si traitement avec controle<-->
      <div *ngIf="Essai.type_essais == 'sans controle'">
        <ion-item *ngIf="!modifierFrom"> 
          <ion-label floating>Selectionnez l'entrée <span class="error-box">*</span></ion-label>
          <ion-select name="nom_entree" [(ngModel)]="selectedTraitement" cancelText="Annuler" okText="Ok" (ionChange)="chargerT(selectedTraitement)">
            <ion-option value="" selected disabled>Selectionnez l'entrée</ion-option>
            <ion-option *ngFor="let t of traitements" [value]=t.doc >{{t.doc.data.nom_entree}}</ion-option>
          </ion-select> 
        </ion-item>
        
        <ion-item *ngIf="modifierFrom"> 
          <ion-label floating>Modifier l'entrée <span class="error-box">*</span></ion-label>
          <ion-select name="nom_entree" [(ngModel)]="Essai.code_traitement" cancelText="Annuler" okText="Ok" (ionChange)="chargerInfoTraitement(Essai.code_traitement)" >
            <ion-option value="" selected disabled>Selectionnez l'entrée</ion-option>
            <ion-option *ngFor="let t of traitements" [value]=t.doc.data.code_traitement >{{t.doc.data.nom_entree}}</ion-option>
          </ion-select> 
        </ion-item>
      </div>

      <!-->Si traitement sans controle<-->
      <div *ngIf="Essai.type_essais == 'avec controle'">
        <ion-row>
          <ion-col>
            <ion-item *ngIf="!modifierFrom"> 
              <ion-label floating>Selectionnez l'entrée <span class="error-box">*</span></ion-label>
              <ion-select name="nom_entree" [(ngModel)]="selectedTraitement" cancelText="Annuler" okText="Ok" (ionChange)="chargerT(selectedTraitement)">
                <ion-option value="" selected disabled>Selectionnez l'entrée</ion-option>
                <ion-option *ngFor="let t of traitements" [value]=t.doc >{{t.doc.data.nom_entree}}</ion-option>
              </ion-select> 
            </ion-item>
            
            <ion-item *ngIf="modifierFrom"> 
              <ion-label floating>Modifier l'entrée <span class="error-box">*</span></ion-label>
              <ion-select name="nom_entree" [(ngModel)]="Essai.code_traitement" cancelText="Annuler" okText="Ok" (ionChange)="chargerInfoTraitement(Essai.code_traitement)" >
                <ion-option value="" selected disabled>Selectionnez l'entrée</ion-option>
                <ion-option *ngFor="let t of traitements" [value]=t.doc.data.code_traitement >{{t.doc.data.nom_entree}}</ion-option>
              </ion-select> 
            </ion-item>
            
          </ion-col>
          <ion-col>
            <ion-item>
              <ion-label floating>Nom controle <span class="error-box">*</span></ion-label>
              <ion-input type="text" [(ngModel)]="Essai.nom_controle" name="nom_controle" disabled></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>  
      </div> 
   </div>

   <!--ion-item>
    <ion-label floating>Superficie essai (m²) <span class="error-box">*</span></ion-label>
    <ion-input type="number" [(ngModel)]="Essai.superficie_essai" name="superficie_essai"></ion-input>
   </ion-item-->


    <div *ngIf="Essai.traitement == 'non' || (Essai.traitement == 'oui' && Essai.type_essais == 'sans controle')">
      <br>
      <ion-row><h5 class="sans-fond-gris"><strong>Info culture <span *ngIf="Essai.type_culture == 'association'">1</span> </strong></h5> </ion-row>
    
      <ion-item *ngIf="selectedProtocole || modifierFrom">
        <ion-label floating>Culture <span class="error-box">*</span></ion-label>
        <ion-select [(ngModel)]="indexSelectedCultureProtocole1" name="cultureProtocole" (ionChange)="changerInfoCultureProtocole(indexSelectedCultureProtocole1)" cancelText="Annuler" okText="Ok">
          <ion-option *ngFor="let cl of culturesProtocole; let i = index" [value]=i>{{cl.doc.data.nom_culture}}</ion-option>
        </ion-select>
      </ion-item>
    
      <ion-item *ngIf="selectedCultureProtocole">
        <ion-label floating>Variété <span class="error-box">*</span></ion-label>
        <ion-select [(ngModel)]="Culture_1.variete" name="variete1" cancelText="Annuler" okText="Ok">
          <ion-option *ngFor="let vr of selectedCultureProtocole.varietes" [value]=vr>{{vr}}</ion-option>
        </ion-select>
      </ion-item>

      <ion-item *ngIf="selectedCultureProtocole">
        <ion-label floating>Superficie essai (m²) <span class="error-box">*</span></ion-label>
        <ion-input type="number" [(ngModel)]="Culture_1.superficie_essai" name="superficie_essai1" [disabled]="selectedProtocole.superficie_essais_modifiable == 'non'"></ion-input>
       </ion-item>
    
      <div *ngIf="selectedCultureProtocole">

        <ion-item *ngFor="let vr of Culture_1.variables_essai; let i=index">
          <ion-label floating>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''"> en {{vr.unite}}</span></ion-label>
          <ion-input *ngIf="vr.type_variable == 'text' || vr.type_variable == ''" type="text" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
          <ion-input *ngIf="vr.type_variable == 'number'" type="number" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
          <ion-textarea *ngIf="vr.type_variable == 'textarea'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" row="6"></ion-textarea>
          <ion-datetime ion-datepicker  (ionChanged)="setDateCulture1($event, i);" *ngIf="vr.type_variable == 'date'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" cancelText="Annuler" okText="Valider"></ion-datetime>
          <ion-checkbox *ngIf="vr.type_variable == 'boolean'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" color="dark"></ion-checkbox>
        </ion-item>
      </div>
    </div>
 
    <div *ngIf="Essai.traitement == 'oui' && Essai.type_essais == 'avec controle'">
      <br>
      <ion-row><h5 class="sans-fond-gris"><strong>Info culture <span *ngIf="Essai.type_culture == 'association'">1</span> </strong></h5> </ion-row>
    
      <ion-item *ngIf="selectedProtocole || modifierFrom">
        <ion-label floating>Culture <span class="error-box">*</span></ion-label>
        <ion-select [(ngModel)]="indexSelectedCultureProtocole1" name="cultureProtocole" (ionChange)="changerInfoCultureProtocole(indexSelectedCultureProtocole1)" cancelText="Annuler" okText="Ok">
          <ion-option *ngFor="let cl of culturesProtocole; let i = index" [value]=i>{{cl.doc.data.nom_culture}}</ion-option>
        </ion-select>
      </ion-item>
    
      <ion-item *ngIf="selectedCultureProtocole">
        <ion-label floating>Variété <span class="error-box">*</span></ion-label>
        <ion-select [(ngModel)]="Culture_1.variete" name="variete1" cancelText="Annuler" okText="Ok">
          <ion-option *ngFor="let vr of selectedCultureProtocole.varietes" [value]=vr>{{vr}}</ion-option>
        </ion-select>
      </ion-item>

      <ion-row *ngIf="selectedCultureProtocole">
        <ion-col>
          <ion-item>
            <ion-label floating>Superficie essai (m²) <span class="error-box">*</span></ion-label>
            <ion-input type="number" [(ngModel)]="Culture_1.superficie_essai" name="superficie_essai1" [disabled]="selectedProtocole.superficie_essais_modifiable == 'non'"></ion-input>
          </ion-item> 
        </ion-col>
        <ion-col>
          <ion-item>
            <ion-label floating>Superficie controle (m²) <span class="error-box">*</span></ion-label>
            <ion-input type="number" [(ngModel)]="Culture_1.superficie_controle" name="superficie_controle" [disabled]="selectedProtocole.superficie_essais_modifiable == 'non'"></ion-input>
          </ion-item>
        </ion-col>
      </ion-row>
    
      <div *ngIf="selectedCultureProtocole">

        <ion-row *ngFor="let vr of Culture_1.variables_essai; let i=index">
          <ion-col>
            <ion-item>
              <ion-label floating>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''"> en {{vr.unite}}</span></ion-label>
              <ion-input *ngIf="vr.type_variable == 'text' || vr.type_variable == ''" type="text" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
              <ion-input *ngIf="vr.type_variable == 'number'" type="number" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
              <ion-textarea *ngIf="vr.type_variable == 'textarea'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" row="6"></ion-textarea>
              <ion-datetime ion-datepicker  (ionChanged)="setDateCulture1($event, i);" *ngIf="vr.type_variable == 'date'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" cancelText="Annuler" okText="Valider"></ion-datetime>
              <ion-checkbox *ngIf="vr.type_variable == 'boolean'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" color="dark"></ion-checkbox>
            </ion-item>
          </ion-col>

          <ion-col>
            <ion-item>
              <ion-label floating>{{Culture_1.variables_controle[i].nom_variable}} controle<span *ngIf="Culture_1.variables_controle[i].unite && Culture_1.variables_controle[i].unite != ''"> en {{Culture_1.variables_controle[i].unite}}</span></ion-label>
              <ion-input *ngIf="Culture_1.variables_controle[i].type_variable == 'text' || Culture_1.variables_controle[i].type_variable == ''" type="text" [(ngModel)]="Culture_1.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
              <ion-input *ngIf="Culture_1.variables_controle[i].type_variable == 'number'" type="number" [(ngModel)]="Culture_1.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
              <ion-textarea *ngIf="Culture_1.variables_controle[i].type_variable == 'textarea'"  [(ngModel)]="Culture_1.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}" row="6"></ion-textarea>
              <ion-datetime ion-datepicker  (ionChanged)="setDateCulture1Controle($event, i);" *ngIf="Culture_1.variables_controle[i].type_variable == 'date'"  [(ngModel)]="Culture_1.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" cancelText="Annuler" okText="Valider"></ion-datetime>
              <ion-checkbox *ngIf="Culture_1.variables_controle[i].type_variable == 'boolean'"  [(ngModel)]="Culture_1.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}" color="dark"></ion-checkbox>
            </ion-item>
          </ion-col>
        </ion-row>

        
      </div>
    </div>
      
      <div *ngIf="Essai.type_culture == 'association'">
        <div *ngIf="Essai.type_essais == 'sans controle'">
          <br>
        <ion-row><h5 class="sans-fond-gris"><strong>Info culture 2 </strong></h5> </ion-row>

        <ion-item *ngIf="selectedProtocole || modifierFrom">
          <ion-label floating>Culture <span class="error-box">*</span></ion-label>
          <ion-select [(ngModel)]="indexSelectedCultureProtocole2" name="cultureProtocole2" (ionChange)="changerInfoCultureProtocole2(indexSelectedCultureProtocole2)" cancelText="Annuler" okText="Ok">
            <ion-option *ngFor="let cl of culturesProtocole2; let i = index" [value]=i>{{cl.doc.data.nom_culture}}</ion-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="selectedCultureProtocole2">
          <ion-label floating>Variété <span class="error-box">*</span></ion-label>
          <ion-select [(ngModel)]="Culture_2.variete" name="variete2" cancelText="Annuler" okText="Ok">
            <ion-option *ngFor="let vr of selectedCultureProtocole2.varietes" [value]=vr>{{vr}}</ion-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="selectedCultureProtocole2">
          <ion-label floating>Superficie essai (m²) <span class="error-box">*</span></ion-label>
          <ion-input type="number" [(ngModel)]="Culture_2.superficie_essai" name="superficie_essai2" [disabled]="selectedProtocole.superficie_essais_modifiable == 'non'"></ion-input>
        </ion-item>
  
            <div *ngIf="selectedCultureProtocole2">

              <ion-item *ngFor="let vr of Culture_2.variables_essai; let i=index">
                <ion-label floating>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''"> en {{vr.unite}}</span></ion-label>
                <ion-input *ngIf="vr.type_variable == 'text' || vr.type_variable == ''" type="text" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
                <ion-input *ngIf="vr.type_variable == 'number'" type="number" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
                <ion-textarea *ngIf="vr.type_variable == 'textarea'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" row="6"></ion-textarea>
                <ion-datetime ion-datepicker  (ionChanged)="setDateCulture2($event, i);" *ngIf="vr.type_variable == 'date'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" cancelText="Annuler" okText="Valider"></ion-datetime>
                <ion-checkbox *ngIf="vr.type_variable == 'boolean'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" color="dark"></ion-checkbox>
              </ion-item>
            </div>
        </div>

        <div *ngIf="Essai.type_essais == 'avec controle'">
          <br>
        <ion-row><h5 class="sans-fond-gris"><strong>Info culture 2 </strong></h5> </ion-row>

        <ion-item *ngIf="selectedProtocole || modifierFrom">
          <ion-label floating>Culture <span class="error-box">*</span></ion-label>
          <ion-select [(ngModel)]="indexSelectedCultureProtocole2" name="cultureProtocole2" (ionChange)="changerInfoCultureProtocole2(indexSelectedCultureProtocole2)" cancelText="Annuler" okText="Ok">
            <ion-option *ngFor="let cl of culturesProtocole2; let i = index" [value]=i>{{cl.doc.data.nom_culture}}</ion-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="selectedCultureProtocole2">
          <ion-label floating>Variété <span class="error-box">*</span></ion-label>
          <ion-select [(ngModel)]="Culture_2.variete" name="variete2" cancelText="Annuler" okText="Ok">
            <ion-option *ngFor="let vr of selectedCultureProtocole2.varietes" [value]=vr>{{vr}}</ion-option>
          </ion-select>
        </ion-item>

        <ion-row *ngIf="selectedCultureProtocole2">
          <ion-col>
            <ion-item>
              <ion-label floating>Superficie essai (m²) <span class="error-box">*</span></ion-label>
              <ion-input type="number" [(ngModel)]="Culture_2.superficie_essai" name="superficie_essai2" [disabled]="selectedProtocole.superficie_essais_modifiable == 'non'"></ion-input>
            </ion-item>
          </ion-col>
          <ion-col>
            <ion-item>
              <ion-label floating>Superficie essai (m²) <span class="error-box">*</span></ion-label>
              <ion-input type="number" [(ngModel)]="Culture_2.superficie_controle" name="superficie_controle2" [disabled]="selectedProtocole.superficie_essais_modifiable == 'non'"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>

            <div *ngIf="selectedCultureProtocole2">
              <ion-row *ngFor="let vr of Culture_2.variables_essai; let i=index">
                <ion-col>
                  <ion-item>
                    <ion-label floating>{{vr.nom_variable}} <span *ngIf="vr.unite && vr.unite != ''"> en {{vr.unite}}</span></ion-label>
                    <ion-input *ngIf="vr.type_variable == 'text' || vr.type_variable == ''" type="text" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
                    <ion-input *ngIf="vr.type_variable == 'number'" type="number" [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
                    <ion-textarea *ngIf="vr.type_variable == 'textarea'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" row="6"></ion-textarea>
                    <ion-datetime ion-datepicker  (ionChanged)="setDateCulture2($event, i);" *ngIf="vr.type_variable == 'date'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" cancelText="Annuler" okText="Valider"></ion-datetime>
                    <ion-checkbox *ngIf="vr.type_variable == 'boolean'"  [(ngModel)]="vr.valeur_variable" [ngModelOptions]="{standalone:true}" color="dark"></ion-checkbox>
                  </ion-item>
                </ion-col>
                <ion-col>
                  <ion-item>
                    <ion-label floating>{{Culture_2.variables_controle[i].nom_variable}} controle <span *ngIf="Culture_2.variables_controle[i].unite && Culture_2.variables_controle[i].unite != ''"> en {{vr.unite}}</span></ion-label>
                    <ion-input *ngIf="Culture_2.variables_controle[i].type_variable == 'text' || Culture_2.variables_controle[i].type_variable == ''" type="text" [(ngModel)]="Culture_2.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
                    <ion-input *ngIf="Culture_2.variables_controle[i].type_variable == 'number'" type="number" [(ngModel)]="Culture_2.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}"></ion-input>
                    <ion-textarea *ngIf="Culture_2.variables_controle[i].type_variable == 'textarea'"  [(ngModel)]="Culture_2.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}" row="6"></ion-textarea>
                    <ion-datetime ion-datepicker  (ionChanged)="setDateCulture2Controle($event, i);" *ngIf="Culture_2.variables_controle[i].type_variable == 'date'"  [(ngModel)]="Culture_2.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}" full="true" calendar="true" locale="fr-FR" clear class="ScheduleDate" displayFormat="DD/MM/YYYY" cancelText="Annuler" okText="Valider"></ion-datetime>
                    <ion-checkbox *ngIf="Culture_2.variables_controle[i].type_variable == 'boolean'"  [(ngModel)]="Culture_2.variables_controle[i].valeur_variable" [ngModelOptions]="{standalone:true}" color="dark"></ion-checkbox>
                  </ion-item>
                </ion-col>
              </ion-row>
              
            </div>
        </div>
        
      </div>

      <br>
      <ion-row><h5 class="sans-fond-gris"><strong>Info complémentaires</strong></h5> </ion-row>

      
      <ion-item>
        <ion-label floating>Objectif de l'essai</ion-label>
        <ion-textarea name="objectif_essai" [(ngModel)]="Essai.objectif_essai" row="6"></ion-textarea>
      </ion-item>

      <ion-row>
        <ion-col>
          <ion-item>
            <ion-label>Effort personnel ?</ion-label>
            <ion-checkbox name="effort_personnel" [(ngModel)]="Essai.effort_personnel" color="dark"></ion-checkbox>
          </ion-item>
        </ion-col>
        <ion-col>
          <ion-item>
            <ion-label>Est Valide ?</ion-label>
            <ion-checkbox name="estValide" [(ngModel)]="Essai.estValide" color="dark"></ion-checkbox>
          </ion-item>
        </ion-col>
      </ion-row>


      <ion-item> 
        <ion-label floating>Le(s) gerant(s) de l'essai</ion-label>
        <ion-select name="gerants" multiple="true" [(ngModel)]="Essai.gerants" cancelText="Annuler" okText="Ok">
          <!--ion-option value="" selected disabled>Selectionnez le(s) gérant(s)</ion-option-->
          <ion-option *ngFor="let g of gerants" [value]=g >{{g}}</ion-option>
        </ion-select> 
      </ion-item>
      
      <ion-item> 
        <ion-label floating>Culture(s) précédante(s)</ion-label>
        <ion-select name="precedante_cultures" multiple="true" [(ngModel)]="Essai.precedante_cultures" cancelText="Annuler" okText="Ok">
          <!--ion-option value="" selected disabled>Selectionnez le précédant culturel</ion-option-->
          <ion-option *ngFor="let pc of precedante_cultures" [value]=pc >{{pc}}</ion-option>
        </ion-select> 
      </ion-item>
  
    <br>
    <button ion-button type="submit" color="my_secondary" block>Sauvegarder</button>
  </form>
  <button ion-button color="my_primary" block (click)="annuler()">Fermer</button>

</div>

  <ion-fab bottom right *ngIf="!ajoutForm && !statistique &&!detailEssai && selectedStyle != 'tableau' && ((user && user.roles && global.estAnimataire(user.roles)) || estAnimataire)" bottom>
    <button ion-fab mini (click)="ajouter()" color="my_primary"><ion-icon name="add"></ion-icon></button>
    <!--button ion-fab mini *ngIf="statistiqueOk" (click)="calculStatisitque(allEssais, traitements)" color="my_primary"><ion-icon name="stats"></ion-icon></button-->
    <button ion-fab mini *ngIf="statistiqueOk" (click)="openMap(allEssais)" color="my_primary"><ion-icon name="pin"></ion-icon></button>
    <!--button ion-fab mini (click)="fusionnerEssais()" color="my_primary">FUS</button-->
  </ion-fab>
  


  <ion-fab bottom right *ngIf="!ajoutForm && !statistique &&!detailEssai && selectedStyle == 'tableau' && ((user && user.roles && global.estAnimataire(user.roles)) || estAnimataire)">
    <button ion-fab color="fuma-green"><ion-icon name="arrow-dropup"></ion-icon></button>
    <ion-fab-list side="top"> 
      <button ion-fab mini *ngIf="essais.length > 0" (click)="onPrint()" color="my_primary"><ion-icon name="print"></ion-icon></button>
      <button ion-fab mini *ngIf="essais.length > 0" (click)="exportExcel()" color="my_primary"><ion-icon name="logo-windows"></ion-icon></button>
      <!--button ion-fab mini *ngIf="essais.length > 0" (click)="export()" color="my_primary"><ion-icon name="share-alt"></ion-icon></button-->
      <button ion-fab mini *ngIf="statistiqueOk" (click)="openMap(allEssais)" color="my_primary"><ion-icon name="pin"></ion-icon></button>
      <button ion-fab mini *ngIf="statistiqueOk" (click)="calculStatisitque(allEssais, traitements)" color="my_primary"><ion-icon name="stats"></ion-icon></button>
      <button ion-fab mini (click)="ajouter()" color="my_primary"><ion-icon name="add"></ion-icon></button>
      
    </ion-fab-list>
  </ion-fab>

  <ion-fab bottom right *ngIf="detailEssai && ((user && user.roles && global.estAnimataire(user.roles)) || estAnimataire)">
    <button ion-fab color="fuma-green"><ion-icon name="arrow-dropup"></ion-icon></button>
    <ion-fab-list side="top">
      <button ion-fab mini *ngIf="(user && user.roles && global.estManager(user.roles)) || estManager" (click)="supprimer(essai)" color="delete" ><ion-icon name="trash"></ion-icon></button>
      <button ion-fab mini (click)="editer(essai)" color="my_primary" ><ion-icon name="create"></ion-icon></button>
    </ion-fab-list>
  </ion-fab>

</ion-content>
